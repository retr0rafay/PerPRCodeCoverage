#!/usr/bin/env bash
set -euo pipefail
set -x
cd "$(cd "$(dirname "${BASH_SOURCE[0]}")/.."; pwd)"

: "${CI:=${bamboo_planRepository_branch-}}"
: "${VERSION=$(cat base_version).${bamboo_buildNumber}}"
: "${FILENAME=breakout-${VERSION}.tar.gz}"
export CI
export VERSION

if [ -n "$CI" ] && [[ "${bamboo_planRepository_branch-}" =~ ^(master$|release-) ]]; then
    tmp=$(mktemp -d)
    tar -czvf $tmp/${FILENAME} *

    # upload
    bamboo-configuration/bin/artifactory/upload.sh 'pd-composer-local/salesforceeng/breakout' "$tmp/${FILENAME}"

    bamboo-configuration/bin/artifactory/properties.sh "pd-composer-local/salesforceeng/breakout/${FILENAME}" PUT composer.version ${VERSION}

    rm -rf target
fi

exit 0
