env:
  CI_PROJECT: PDT
  CI_PLAN: CRMB
  CI_BUILD: ${CI_PROJECT}-${CI_PLAN}-${BUILDKITE_BUILD_NUMBER}

steps:
  - label: ":docker: Build"
    plugins:
      - ${DOCKER_COMPOSE_PLUGIN}:
          build: crumb
          image-name: ${CI_BUILD}
          image-repository: ${DOCKER_BUILD_BASE}/crumb/crumb
          cache-from: crumb:${DOCKER_BUILD_BASE}/crumb/crumb:unstable

  - wait

  - label: ":php: Test"
    command: vendor/phpunit/phpunit/phpunit
    plugins:
      - ${DOCKER_COMPOSE_PLUGIN}:
          run: crumb

  - wait

  - label: ":docker: Push"
    plugins:
      - ${DOCKER_COMPOSE_PLUGIN}:
          push:
            - crumb:${DOCKER_BUILD_BASE}/crumb/crumb:unstable
